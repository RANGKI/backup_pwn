<?php
if ($_SERVER["REQUEST_METHOD"] === "POST") {
    $uploadDir = "uploads/";
    $flagFile = "flag.txt"; // Path to your flag file
    $allowedExtensions = ["jpg", "jpeg", "png", "gif"];
    $maxFileSize = 2 * 1024 * 1024; // 2MB

    if (!isset($_FILES["foto"]) || $_FILES["foto"]["error"] !== UPLOAD_ERR_OK) {
        die("Terjadi kesalahan saat mengunggah file.");
    }

    $fileTmpPath = $_FILES["foto"]["tmp_name"];
    $fileName = basename($_FILES["foto"]["name"]);


    $fileSize = $_FILES["foto"]["size"];
    $fileExt = strtolower(pathinfo($fileName, PATHINFO_EXTENSION));

    // VULNERABILITY 1: Insufficient extension checking
    // Only checks the last extension but doesn't validate the actual content
    if (!in_array($fileExt, $allowedExtensions)) {
        die("Format file tidak diizinkan! Hanya diperbolehkan: JPG, JPEG, PNG, GIF.");
    }

    // Validasi ukuran file
    if ($fileSize > $maxFileSize) {
        die("Ukuran file terlalu besar! Maksimal 2MB.");
    }

    // VULNERABILITY 2: Missing MIME type validation
    // The original code checked MIME type, this version doesn't

    // VULNERABILITY 3: Preserving original filename
    // This allows multiple extensions like image.php.jpg
    $newFileName = $fileName;
    $filePath = $uploadDir . $newFileName;

    // VULNERABILITY 4: Permissions are too permissive
    if (!is_dir($uploadDir)) {
        mkdir($uploadDir, 0777, true); // 0777 is very permissive
    }

    // Pindahkan file ke folder upload
    if (move_uploaded_file($fileTmpPath, $filePath)) {
        // Check if this is an attempted PHP exploit
        // Simplified detection - in a real CTF you might want more complex logic
        $fileContent = file_get_contents($filePath);
        
        // Check for PHP tags in the file content - this indicates a successful exploit
        if (strpos($fileContent, '<?php') !== false || strpos($fileContent, '<?=') !== false) {
            // Successful exploit - show the flag content
            if (file_exists($flagFile)) {
                $flag = file_get_contents($flagFile);
                echo "<h2>Congratulations! You've successfully exploited the upload vulnerability!</h2>";
                echo "<div style='padding: 20px; background-color: #f0f0f0; border: 1px solid #ccc;'>";
                echo "<h3>Flag:</h3>";
                echo "<pre>$flag</pre>";
                echo "</div>";
                echo "<p><a href='data.php'>Back to Form</a></p>";
                
                // Log the successful exploit
                error_log("[" . date("Y-m-d H:i:s") . "] Successful file upload exploit by " . $_SERVER['REMOTE_ADDR']);
                
                // Delete the malicious file for safety
                unlink($filePath);
                exit;
            } else {
                echo "<h2>Almost there! But the flag file is missing.</h2>";
                echo "<p>This would be a successful exploit in the real challenge.</p>";
                exit;
            }
        } else {
            // Not a successful exploit - redirect to confirmation page with form data
            $params = [];
            // Add all POST data as URL parameters
            foreach ($_POST as $key => $value) {
                $params[] = urlencode($key) . '=' . urlencode($value);
            }
            // Add the path to the uploaded image
            $params[] = 'foto=' . urlencode($newFileName);

            
            // Redirect with all parameters
            header("Location: konfirmasi.php?" . implode('&', $params));
            exit;
        }
    } else {
        die("Gagal menyimpan file.");
    }
    echo "<p>File berhasil diunggah: " . htmlspecialchars($filePath) . "</p>";
}
?>